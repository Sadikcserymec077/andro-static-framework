<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scan Results ‚Äî Static Analysis Framework</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-light py-3 shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/">üîç Static Analysis Framework</a>
  
      <div class="ms-auto d-flex align-items-center gap-3">
        <a class="btn btn-outline-primary" href="/">Upload</a>
        <a class="btn btn-outline-secondary" href="/history">History</a>
        <a class="btn btn-outline-secondary" href="/about">About</a>
      </div>
    </div>
  </nav>
  

<main class="container my-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3>Scan Results</h3>
      <div class="small-muted">Scan ID: <code>{{ scan_id }}</code></div>
    </div>

    <div class="text-end">
      <div class="small-muted">Total Issues</div>
      <div class="big-number">{{ total_issues }}</div>
      <div class="mt-2">
        <button id="exportChartBtn" class="btn btn-success">üìÑ Export PDF (with chart)</button>
        <a class="btn btn-outline-secondary" href="{{ url_for('export', scan_id=scan_id) if false else url_for('export_pdf', scan_id=scan_id) }}">üìÑ Export (text)</a>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-md-3">
      <div class="card p-3">
        <div class="small-muted">Total Issues</div>
        <div class="big-number">{{ total_issues }}</div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card p-3">
        <div class="small-muted">High</div>
        <div class="fw-bold fs-3 text-danger">{{ severity_counts['High'] }}</div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card p-3">
        <div class="small-muted">Medium</div>
        <div class="fw-bold fs-3 text-warning">{{ severity_counts['Medium'] }}</div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card p-3">
        <div class="small-muted">Low</div>
        <div class="fw-bold fs-3 text-info">{{ severity_counts['Low'] }}</div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-lg-6">
      <div class="card p-3">
        <h5>Severity Breakdown</h5>
        <canvas id="severityChart" height="220"></canvas>
      </div>

      <div class="card p-3 mt-3">
        <h6>Permissions</h6>
        <ul class="list-group list-group-flush">
          {% for p in permissions %}
            <li class="list-group-item small">{{ p }}</li>
          {% else %}
            <li class="list-group-item small text-muted">No permissions data</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card p-3">
        <h6>Third-Party Libraries</h6>
        <ul class="list-group list-group-flush">
          {% for lib in libraries %}
            <li class="list-group-item small">
              <strong>{{ lib.get('name') or lib.get('library') or lib }}</strong>
              <span class="badge bg-secondary ms-2">{{ lib.get('risk') or lib.get('version', '') }}</span>
            </li>
          {% else %}
            <li class="list-group-item small text-muted">No libraries found</li>
          {% endfor %}
        </ul>
      </div>

      <div class="card p-3 mt-3">
        <h6>Manifest Issues</h6>
        <ul class="list-group list-group-flush">
          {% for m in manifest_issues %}
            <li class="list-group-item small">{{ m.title if m.title else m }}</li>
          {% else %}
            <li class="list-group-item small text-muted">No manifest issues</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <div class="card p-3 mt-4">
    <div class="d-flex justify-content-between align-items-center">
      <h5>Vulnerabilities</h5>
      <div>
        <label class="me-2 small">Filter:</label>
        <select id="severityFilter" class="form-select form-select-sm d-inline-block" style="width:160px">
          <option value="All">All</option>
          <option value="High">High</option>
          <option value="Medium">Medium</option>
          <option value="Low">Low</option>
          <option value="Info">Info</option>
        </select>
      </div>
    </div>

    <div class="table-responsive mt-3">
      <table class="table table-hover" id="vulnTable">
        <thead class="table-light">
          <tr>
            <th>Title</th>
            <th>File</th>
            <th>Severity</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="vulnTbody">
          {% for v in vulnerability_list %}
            <tr data-severity="{{ (v.get('severity') or v.get('level') or 'Info') }}">
              <td>{{ v.get('title') or v.get('name') or 'Unnamed' }}</td>
              <td>{{ v.get('file', '-') }}</td>
              <td>
                {% set sev = (v.get('severity') or v.get('level') or 'Info') %}
                {% if sev|lower == 'high' %}
                  <span class="badge bg-danger">{{ sev }}</span>
                {% elif sev|lower == 'medium' %}
                  <span class="badge bg-warning text-dark">{{ sev }}</span>
                {% elif sev|lower == 'low' %}
                  <span class="badge bg-info text-dark">{{ sev }}</span>
                {% else %}
                  <span class="badge bg-secondary">{{ sev }}</span>
                {% endif %}
              </td>
              <td>
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#vulnModal{{ loop.index }}">Details</button>
              </td>
            </tr>

            <!-- vulnerability modal -->
            <div class="modal fade" id="vulnModal{{ loop.index }}" tabindex="-1">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">{{ v.get('title') or v.get('name') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <p><strong>File:</strong> {{ v.get('file', '-') }} &nbsp; <strong>Line:</strong> {{ v.get('line', '-') }}</p>
                    <p><strong>Severity:</strong> {{ v.get('severity') or v.get('level') or 'Info' }}</p>
                    <p><strong>Mitigation:</strong> {{ v.get('mitigation') }}</p>
                    <hr>
                    <pre style="background:#f8f9fa;border-radius:6px;padding:12px;white-space:pre-wrap;">{{ v.get('code_snippet') or 'No code snippet available.' }}</pre>
                  </div>
                  <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  </div>
                </div>
              </div>
            </div>
          {% else %}
            <tr><td colspan="4" class="small text-muted">No vulnerabilities found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Mitigation tips -->
  <div class="card p-3 mt-4">
    <h6>Mitigation Tips (Common)</h6>
    <ul>
      <li><strong>Avoid hardcoded keys:</strong> Use Android Keystore or server-side secrets.</li>
      <li><strong>Secure network:</strong> Use certificate pinning and enforce TLS.</li>
      <li><strong>Limit exported components:</strong> Mark activities/services non-exported unless required.</li>
      <li><strong>Minimize permissions:</strong> Request only needed runtime permissions.</li>
    </ul>
  </div>

</main>

<!-- Javascript -->
<script>
  window.SEVERITY_COUNTS = {
    High: {{ severity_counts['High'] }},
    Medium: {{ severity_counts['Medium'] }},
    Low: {{ severity_counts['Low'] }},
    Info: {{ severity_counts.get('Info', 0) }}
  };
  window.SCAN_ID = "{{ scan_id }}";
</script>

<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Export chart handler -->
<script>
document.getElementById("exportChartBtn").addEventListener("click", async function() {
  const canvas = document.getElementById("severityChart");
  if (!canvas) { alert("Chart not found"); return; }
  const dataUrl = canvas.toDataURL("image/png");
  const resp = await fetch(`/export_chart/${window.SCAN_ID}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ chart: dataUrl })
  });
  if (!resp.ok) {
    const text = await resp.text();
    alert("Export failed: " + text);
    return;
  }
  const blob = await resp.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `scan_${window.SCAN_ID}_chart.pdf`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});
</script>

</body>
</html>
